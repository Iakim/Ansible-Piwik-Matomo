---
- hosts: test
  remote_user: root

  tasks:

  - name: Parando o serviço do Firewall
    service: name=firewalld state=stopped enabled=no

  - selinux:
      state: disabled

  - name: Instalando o Apache
    yum: state=latest name={{ item }}
    with_items:
    - httpd
    - httpd-devel

  - name: Instalando o Banco de Dados
    yum: state=latest name={{ item }}
    with_items:
    - mariadb
    - mariadb-server

  - name: Instalando o PHP
    yum: state=latest name={{ item }}
    with_items:
    - php71w
    - php71w-cli
    - php71w-pdo
    - php71w-xml
    - php71w-devel
    - php71w-gd
    - php71w-mbstring
    - php71w-mysqlnd
    - php71w-pear
    - php71w-process

  - name: Inciando o Banco de Dados
    service: name=mariadb state=started enabled=yes

  - name: Instalando Wget
    yum: state=latest name=wget

  - name: Realizando download do piwik
    get_url:
      url: https://builds.piwik.org/piwik.zip
      dest: /opt

  - name: Descompatando arquivo
    shell: unzip /opt/piwik.zip -d /var/www/html

  - name: Concedendo permissão ao Apache
    shell: chown -R apache:apache /var/www/html/piwik

  - name: Configuring php.ini
    lineinfile:
      path: /etc/php.ini
      regexp: '^;always_populate_raw_post_data = -1'
      line: 'always_populate_raw_post_data = -1'

  - name: Adicionando GeoIP (Php)
    get_url:
      url: http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
      dest: /var/www/html/piwik/misc

  - name: Descompactando arquivos .dat
    shell: gzip -d /var/www/html/piwik/misc/GeoLiteCity.dat.gz

  - name: Renomenado arquivo .dat
    shell: mv /var/www/html/piwik/misc/GeoLiteCity.dat /var/www/html/piwik/misc/GeoIPCity.dat

  - name: Habilitando o serviço do Apache
    service: name=httpd state=started enabled=yes
